{% extends "base.html" %}

{% block title %}UPSC RAG Chat{% endblock %}

{% block content %}
<section class="max-w-4xl mx-auto px-4 py-10">
  <h1 class="text-2xl font-bold mb-2">UPSC Knowledge Base Chat</h1>
  <p class="text-gray-600 mb-4">
    Have a continuous conversation grounded from UPSC content (books, essays, NCERT, PYQ).
  </p>

  {% if error %}
    <div class="mb-4 p-3 rounded-md bg-red-50 text-red-700 text-sm">
      {{ error }}
    </div>
  {% endif %}

  <!-- Chat history -->
  <div class="bg-white border border-gray-200 rounded-lg mb-4 max-h-[480px] overflow-y-auto p-4 space-y-3">
    {% if chat_history %}
      {% for m in chat_history %}
        <div class="{% if m.role == 'user' %}text-right{% else %}text-left{% endif %}">
          <div class="inline-block px-4 py-2 rounded-2xl text-sm whitespace-pre-wrap
                      {% if m.role == 'user' %}bg-blue-600 text-white{% else %}bg-gray-100 text-gray-800{% endif %}">
            {{ m.content }}
          </div>
        </div>
      {% endfor %}
    {% else %}
      <p class="text-sm text-gray-400">
        Start by asking a question about polity, economy, history, ethics, or any UPSC topic.
      </p>
    {% endif %}
  </div>

  <!-- Input form -->
  <form method="post" class="mt-2">
    {% csrf_token %}
    <label for="question" class="block text-sm font-medium text-gray-700 mb-1">Start Chat</label>
    <textarea
      id="question"
      name="question"
      rows="3"
      class="w-full p-3 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-600 focus:outline-none"
      placeholder="e.g. Explain the concept of cooperative federalism in the Indian context."
    ></textarea>

    <button
      type="submit"
      class="mt-3 inline-flex items-center px-4 py-2 bg-blue-700 text-white rounded-md hover:bg-blue-800"
    >
      Send
    </button>
  </form>

  {% if sources %}
    <div class="mt-6">
      <h3 class="text-lg font-semibold mb-2">Sources Used (latest answer)</h3>
      <ul class="list-disc list-inside text-sm text-gray-700">
        {% for s in sources %}
          <li>
            <span class="font-medium">{{ s.source }}</span>
            <span class="ml-1 text-gray-500">(relevance: {{ s.relevance|floatformat:3 }})</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}
</section>

{% endblock %}
